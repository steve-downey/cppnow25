<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title><code>std::optional&lt;T&amp;&gt;</code></title>
<meta name="author" content="Steve Downey"/>
<meta name="description" content="
"/>
<meta name="keywords" content=" "/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="../etc/my_theme.css" id="theme"/>

<link rel="stylesheet" href="../etc/modus-vivendi-tinted.css"/>

<link rel="stylesheet" href="../etc/footer.css"/>
<link rel="stylesheet" type="text/css" href="../etc/modus-vivendi-tinted.css"/>
<link rel="stylesheet" type="text/css" href="../etc/modus-vivendi-tinted.css" />
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-background="./title.png">
<p>
</section>
<section>
<section id="slide-org8eccb35">
<h2 id="org8eccb35">Colophon</h2>
<ul>
<li>Slideware: <a href="https://revealjs.com/">reveal.js</a></li>
<li>Slide Preperation: <a href="https://gitlab.com/oer/org-re-reveal">org-re-reveal</a></li>
<li>Fonts: <a href="https://www.brailleinstitute.org/freefont/">Atkinson Hyperlegible</a> Next and Mono</li>
<li>Color Themes: <a href="https://github.com/protesilaos/modus-themes">Modus</a> Vivendi and Operandi Tinted</li>

</ul>

<p>
Intended to conform to <a href="https://www.w3.org/WAI/WCAG2AAA-Conformance">Web Content Accessibility Guidelines Level AAA</a>
</p>


<div id="org6c6d12e" class="figure">
<p><img src="../etc/wcag2.2AAA-blue.svg" alt="wcag2.2AAA-blue.svg" class="org-svg" height="32" width="88px" />
</p>
</div>
</section>
</section>
<section>
<section id="slide-org773c1cd">
<h2 id="org773c1cd">Standardising Optionals over References</h2>
<p>
Optionals were first proposed for C++ in 2005.
</p>

<p>
Optional&lt;T&gt; where T is constrained not to be a reference was added in 2017.
</p>

<p>
Optionals for lvalue references are on track for C++26.
</p>

<aside class="notes">
<div class="org-src-container">

<pre class="src src-cpp">0         1         2         3         4         5         6         7
01234567890123456789012345678901234567890123456789012345678901234567890123456789
</pre>
</div>

<p>
This talk will discuss the early history, starting with Boost.Optional and <a href="#citeproc_bib_item_4">“N1878: A Proposal to Add an Utility Class to Represent Optional Objects (Revision 1)”</a>, and what the early concerns were for the reference specialization.  <a href="#citeproc_bib_item_7">“P1175R0: A Simple and Practical Optional Reference for c++”</a> ,  reproposed reference support for C++20, which was not adopted. <a href="#citeproc_bib_item_8">“P1683R0: References for Standard Library Vocabulary Types - an Optional Case Study”</a>,  in 2020 surveyed existing behavior of optional references in the wild, and pointed out the trap of assingment behaviour being state dependent. <a href="#citeproc_bib_item_6">“P2988R0: Std:Optional”</a> picked up the torch again in 2023, of which revision 9 is the proposal which is design approved by the Library Evolution Working Group.
</p>

<p>
In 2024, the proposal to make optional a range, <a href="#citeproc_bib_item_9">“P3168R0: Give Std:Optional Range Support”</a>, as opposed to having a separate range of zero or one, was adopted. The reference implementation for <code>optional&lt;T&amp;&gt;</code> and the test cases for <code>views::maybe</code> were used to vet the additional interfaces for optional range support. This merged implementation became one of the first Beman libraries, where the library and the optional reference proposal  benefited immensly from the visibility and feedback.
</p>

</aside>
</section>
<section id="slide-org9b3d7d6">
<h3 id="org9b3d7d6">Why so long?</h3>
<ul>
<li>What were the concerns that made the process take so long?</li>
<li>How were concerns addressed?</li>
<li>What did we end up with?</li>
<li>What remains to be done?</li>

</ul>

<aside class="notes">
<p>

</p>

<p>
The core of the difficulty has been that references are not values  and  types containing a reference do not have value semantics. References do not fit comfortably in the C++ type system. The core value semantic type that also has reference semantics is a pointer, but pointers have underconstrained and unsafe semantics. The long discussion has been a proxy for what reference semantic types should look like in value semantic types in the standard library, particularly for "sum" types, like <code>expected</code> and <code>variant</code>, but also for types such as <code>single</code>.
</p>

</aside>
</section>
</section>
<section>
<section id="slide-org05db46f">
<h2 id="org05db46f">Quick overview of optional&lt;T&amp;&gt;</h2>
<p>
A non-owning type with reference semantics with one additional value representing the empty state.
</p>
</section>
<section id="slide-org0e458f4">
<h3 id="org0e458f4">intro</h3>
<div class="org-src-container">

<pre class="src src-cpp"><span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-keyword">class</span> <span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span> &amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">public</span>:
        <span class="org-keyword">using</span> <span class="org-type">value_type</span> = T;
        <span class="org-keyword">using</span> <span class="org-type">iterator</span> = implementation_defined;

      <span class="org-keyword">public</span>:
</pre>
</div>
</section>
<section id="slide-org7519ee3">
<h3 id="org7519ee3">Constructors</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> <span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">noexcept</span> = <span class="org-keyword">default</span>;
        <span class="org-keyword">constexpr</span> <span class="org-function-name">optional</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">nullopt_t</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span> : optional<span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{}</span>
        <span class="org-keyword">constexpr</span> <span class="org-function-name">optional</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">optional</span> &amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> nboexcept = <span class="org-keyword">default</span>;
</pre>
</div>
</section>
<section id="slide-org098f4e2">
<h3 id="org098f4e2">Constructors (continued)</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">Arg</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span> <span class="org-function-name">optional</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">in_place_t</span>, <span class="org-type">Arg</span> &amp;&amp;<span class="org-variable-name">arg</span><span class="org-rainbow-delimiters-depth-1">)</span>;
        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>
                optional<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">U</span> &amp;&amp;<span class="org-variable-name">u</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>;

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>
                optional<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">U</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>;

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>
                optional<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">U</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>;

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>
                optional<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">U</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;&amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>;

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>
                optional<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">U</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;&amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</section>
<section id="slide-org136e722">
<h3 id="org136e722">Destructor</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> ~<span class="org-function-name">optional</span><span class="org-rainbow-delimiters-depth-1">()</span> = <span class="org-keyword">default</span>;
</pre>
</div>
</section>
<section id="slide-org36974b6">
<h3 id="org36974b6">Assignment</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> <span class="org-type">optional</span> &amp;<span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">nullopt_t</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span>;
        <span class="org-keyword">constexpr</span> <span class="org-type">optional</span> &amp;<span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">optional</span> &amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span> = <span class="org-keyword">default</span>;
        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-keyword">constexpr</span> <span class="org-type">T</span> &amp;<span class="org-function-name">emplace</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">U</span> &amp;&amp;<span class="org-variable-name">u</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-comment-delimiter">/*</span><span class="org-comment">see below</span><span class="org-comment-delimiter">*/</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</section>
<section id="slide-org7387fcf">
<h3 id="org7387fcf">Swap</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> <span class="org-type">void</span> <span class="org-function-name">swap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">optional</span> &amp;<span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">noexcept</span>;
</pre>
</div>
</section>
<section id="slide-org57b7564">
<h3 id="org57b7564">Iterator</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> <span class="org-type">iterator</span> <span class="org-function-name">begin</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span>;
        <span class="org-keyword">constexpr</span> <span class="org-type">iterator</span> <span class="org-function-name">end</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span>;
</pre>
</div>
</section>
<section id="slide-orgdd01b36">
<h3 id="orgdd01b36">Observers</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> <span class="org-type">T</span> *<span class="org-keyword">operator</span><span class="org-function-name">-&gt;</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span>;
        <span class="org-keyword">constexpr</span> <span class="org-type">T</span> &amp;<span class="org-keyword">operator</span><span class="org-function-name">*</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span>;
        <span class="org-keyword">constexpr</span> <span class="org-keyword">explicit</span> <span class="org-keyword">operator</span> <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span>;
        <span class="org-keyword">constexpr</span> <span class="org-type">bool</span> <span class="org-function-name">has_value</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span>;
        <span class="org-keyword">constexpr</span> <span class="org-type">T</span> &amp;<span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">freestanding-deleted</span>
        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span> = <span class="org-type">remove_cv_t</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-type">remove_cv_t</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-function-name">value_or</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">U</span> &amp;&amp;<span class="org-variable-name">u</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">const</span>;
</pre>
</div>
</section>
<section id="slide-orgde35e22">
<h3 id="orgde35e22">Monadic Operations</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">F</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-keyword">constexpr</span> <span class="org-keyword">auto</span> <span class="org-function-name">and_then</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">F</span> &amp;&amp;<span class="org-variable-name">f</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">const</span>;

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">F</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">invoke_result_t</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">F</span>, <span class="org-type">T</span> &amp;<span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-function-name">transform</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">F</span> &amp;&amp;<span class="org-variable-name">f</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">const</span>;

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">F</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-keyword">constexpr</span> <span class="org-type">optional</span> <span class="org-function-name">or_else</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">F</span> &amp;&amp;<span class="org-variable-name">f</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">const</span>;
</pre>
</div>
</section>
<section id="slide-org9785a51">
<h3 id="org9785a51">Modifiers</h3>
<div class="org-src-container">

<pre class="src src-cpp">        <span class="org-keyword">constexpr</span> <span class="org-type">void</span> <span class="org-function-name">reset</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">noexcept</span>;
</pre>
</div>
</section>
<section id="slide-org78d3610">
<h3 id="org78d3610">Exposition-only Details</h3>
<div class="org-src-container">

<pre class="src src-cpp">      <span class="org-keyword">private</span>:
        <span class="org-type">T</span> *<span class="org-variable-name">val</span> = <span class="org-constant">nullptr</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">exposition only</span>

        <span class="org-keyword">template</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">U</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
        <span class="org-keyword">constexpr</span> <span class="org-type">void</span> <span class="org-function-name">convert_ref_init_val</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">U</span> &amp;&amp;<span class="org-variable-name">u</span><span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">exposition only</span>
<span class="org-rainbow-delimiters-unmatched">}</span>;
</pre>
</div>
</section>
</section>
<section>
<section id="slide-org13fd7c5">
<h2 id="org13fd7c5">The Papers</h2>
<ul>
<li>2005: N1878: A Proposal to Add an Utility Class to Represent Optional Objects (Revision 1)</li>
<li>2012: N3406: A Proposal to Add a Utility Class to Represent Optional Objects (Revision 2)</li>
<li>2013: N3527: A Proposal to Add a Utility Class to Represent Optional Objects (Revision 3)</li>
<li>2013: N3672: A Proposal to Add a Utility Class to Represent Optional Objects (Revision 4)</li>
<li>2015: N4529: Working Draft, C++ Extensions for Library Fundamentals, Version 2</li>
<li>2016: P0220R0: Adopt Library Fundamentals TS  for c++17</li>
<li>2018: P1175R0: A Simple and Practical Optional Reference for C++</li>
<li>2020: P1683R0: References for Standard Library Vocabulary Types - An Optional Case Study</li>
<li>2023: P2988R0: <code>std:optional&lt;T&amp;&gt;</code></li>

</ul>


<aside class="notes">
<p>
Optional was pulled at the last moment of 14 because of UB in the implementation technique of placement new with a storage buffer.
Library TSs hadn't fully failed at that point.









</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgf76dcbf">
<h2 id="orgf76dcbf">The Problems</h2>
<div class="outline-text-2" id="text-orgf76dcbf">
</div>
</section>
<section id="slide-org6c2fcc6">
<h3 id="org6c2fcc6">Assign or Rebind?</h3>
<div class="org-src-container">

<pre class="src src-cpp"><span class="org-type">Cat</span> <span class="org-variable-name">fynn</span>;
<span class="org-type">Cat</span> <span class="org-variable-name">loki</span>;
<span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">Cat</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-variable-name">maybeCat1</span>;
<span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">Cat</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-variable-name">maybeCat2</span><span class="org-rainbow-delimiters-depth-1">{</span>fynn<span class="org-rainbow-delimiters-depth-1">}</span>;
maybeCat1 = loki;
maybeCat2 = fynn;
</pre>
</div>
<p>
What do those assignments do?
</p>

<p>
Ought they be allowed?
</p>

<p>
State independence won out, eventually.
</p>
<aside class="notes">
<p>

</p>

</aside>
</section>
<section id="slide-orgce19d87">
<h3 id="orgce19d87">Non-generic template</h3>
<p>
<code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span></code> violates genericity.
</p>

<p>
The "<code class="src src-cpp"><span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">&gt;</span></code>" problem only for an entire value category.
</p>

<p>
Reference categories are weird and non-generic.
</p>
</section>
<section id="slide-org4098c6c">
<h3 id="org4098c6c">Constexpr and UB issues</h3>
<p>
At the time of C++14 they couldn't quite be constexpr.
</p>

<p>
<i>Placement new</i> had issues as did <code>union</code> techniques.
</p>

<p>
We taught the compiler to <code>constexpr</code> more things.
</p>
</section>
</section>
<section>
<section id="slide-org2ac4f3b">
<h2 id="org2ac4f3b">Design Choices</h2>
<div class="outline-text-2" id="text-org2ac4f3b">
</div>
</section>
<section id="slide-org2874b89">
<h3 id="org2874b89"><code class="src src-cpp">make_optional<span class="org-rainbow-delimiters-depth-1">()</span></code></h3>
<p>
<code class="src src-cpp">make_optional<span class="org-rainbow-delimiters-depth-1">()</span></code> was largely supplanted by CTAD.
</p>

<p>
<code class="src src-cpp">make_optional<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;()</span></code> creates an <code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>T<span class="org-rainbow-delimiters-depth-1">&gt;</span></code>. Doing otherwise would have been worse.
</p>
</section>
<section id="slide-orgce9d416">
<h3 id="orgce9d416">Trivial construction</h3>
<p>
<code class="src src-cpp">is_trivial</code> is deprecated in 26.
</p>

<p>
No worse than they have to be.
</p>
</section>
<section id="slide-orgf964f0e">
<h3 id="orgf964f0e">Value Category Affect on <code class="src src-cpp"><span class="org-constant">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span>::value<span class="org-rainbow-delimiters-depth-1">()</span> &amp;&amp;</code></h3>
<p>
What should <code class="src src-cpp"><span class="org-constant">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span>::value<span class="org-rainbow-delimiters-depth-1">()</span>&amp;&amp;;</code> return?
</p>

<p>
Choose to model pointers, a reference semantic value type.
</p>

<p>
Value category of the object does not affect value category of the referent.
</p>

<p>
Otherwise an rvalue <code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span></code> could enable moves from the referent.
</p>
</section>
<section id="slide-org81d4320">
<h3 id="org81d4320">Shallow vs. Deep <code class="src src-cpp"><span class="org-keyword">const</span></code></h3>
<p>
What should <code class="src src-cpp"><span class="org-constant">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span>::value<span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span>;</code> return?
</p>

<p>
Choose to model pointers, a reference semantic value type.
</p>

<p>
A <code>const</code> pointer is not a pointer to <code>const</code>.
</p>

<p>
All langauge references are <code>const</code>. An <code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span></code> is a reference semantic type.
</p>

<p>
Not a reference.
</p>
</section>
<section id="slide-orgc5e7c84">
<h3 id="orgc5e7c84">Conditional Explicit</h3>
<p>
Is <code class="src src-cpp">optional<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;(</span>x<span class="org-rainbow-delimiters-depth-1">)</span></code> required to construct an <code>optional&lt;T&amp;&gt;</code>?
</p>

<p>
I would have preferred to, but it was too painful.
</p>

<p>
However lack of <code>explicit</code> makes the type exponentially more complex,  as there are more interactions between member functions.
</p>
</section>
<section id="slide-org5c07ed1">
<h3 id="org5c07ed1"><code class="src src-cpp">value_or</code></h3>
<p>
What should <code class="src src-cpp"><span class="org-constant">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span>::value_or<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">U</span> &amp;&amp;<span class="org-variable-name">u</span><span class="org-rainbow-delimiters-depth-1">)</span>;</code> return?
</p>

<p>
What is the "value type" for an optional?
</p>

<p>
All choices are surprising to someone.
</p>

<p>
Chose to return T, as that seems least dangerous.
</p>

<p>
Future work: generic <code class="src src-cpp">nullable</code> functions.
</p>
</section>
<section id="slide-orga10d5f9">
<h3 id="orga10d5f9"><code class="src src-cpp">in_place_t</code> construction</h3>
<p>
There is no "place" to construct.
</p>
</section>
<section id="slide-org3a350dd">
<h3 id="org3a350dd">Converting assignment</h3>
<p>
Avoid conversions that produce temporaries.
</p>

<p>
Avoid confusion with <code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">U</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span></code> or <code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>T<span class="org-rainbow-delimiters-depth-1">&gt;</span></code> constructors.
</p>

<p>
Large <i>overload sets</i> are difficult to reason about.
</p>
</section>
</section>
<section>
<section id="slide-org26b3164">
<h2 id="org26b3164">Reification Principles</h2>
<div class="outline-text-2" id="text-org26b3164">
</div>
</section>
<section id="slide-org2d10eca">
<h3 id="org2d10eca">Construction from temporary</h3>
<p>
Avoid taking references to temporaries.
</p>

<p>
Rules out some safe cases, disallows many dangerous cases.
</p>
</section>
<section id="slide-orgf393cef">
<h3 id="orgf393cef">Deleting dangling overloads</h3>
<p>
Delete, rather than remove via <code>concept</code>,  function overloads that produce dangling references.
</p>
</section>
<section id="slide-org2a030cf">
<h3 id="org2a030cf">Assignment of <code class="src src-cpp"><span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span></code></h3>
<p>
Assignment of an optional&lt;T&amp;&gt; is equivalent to a pointer copy.
</p>

<p>
All assignments are through the single function.
</p>
</section>
</section>
<section>
<section id="slide-org4074356">
<h2 id="org4074356">The T&amp; Problem</h2>
<div class="outline-text-2" id="text-org4074356">
</div>
</section>
<section id="slide-orgb863197">
<h3 id="orgb863197">Overloaded syntax</h3>
<p>
Used for:
</p>
<ul>
<li class="fragment appear">Parameter Passing</li>
<li class="fragment appear">Named alias</li>
<li class="fragment appear">Non-null const pointer in a struct</li>

</ul>
</section>
<section id="slide-orgbf3b6fa">
<h3 id="orgbf3b6fa">References are not Data</h3>
<p>
They are CoData.
</p>

<p>
Much more about this in my Streams talk.
</p>
</section>
<section id="slide-org8dc385d">
<h3 id="org8dc385d"><code>T&amp;</code> in an Generic Algebraic Type</h3>
<ul>
<li class="fragment appear">Request for reference semantics.</li>
<li class="fragment appear">Not a request for T&amp; weirdness.</li>
<li class="fragment appear">Biggest problem for Union-like types &#x2013; Sum Types.</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgfdf728d">
<h2 id="orgfdf728d">Project Beman</h2>
<div class="outline-text-2" id="text-orgfdf728d">
</div>
</section>
<section id="slide-orga35ef8b">
<h3 id="orga35ef8b">Began last year at C++Now 2024</h3>
<p>
Not a requirement for Standardization.
</p>

<p>
LEWG is getting better at asking for implementation of exact proposal.
</p>

<p>
Details matter.
</p>
</section>
<section id="slide-orgc9a1b69">
<h3 id="orgc9a1b69">Pre-existing smd::optional</h3>
<p>
Confirmed at Tokyo, live, that the range-ification would work for my test cases for <code>views::maybe</code>.
</p>

<p>
Unfortunately <code>smd::optional</code> used early-Modern CMake.
</p>

<p>
This meant rework to bring it to current standards.
</p>
</section>
<section id="slide-org2824b97">
<h3 id="org2824b97">The ref-stealing bug found</h3>
<div class="org-src-container">

<pre class="src src-cpp"><span class="org-type">Cat</span> <span class="org-variable-name">fynn</span>;
<span class="org-constant">std</span>::<span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">Cat</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-variable-name">maybeCatRef</span><span class="org-rainbow-delimiters-depth-1">{</span>fynn<span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-constant">std</span>::<span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">Cat</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-variable-name">maybeCat</span>;
maybeCat = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-1">(</span>maybeCatRef<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">fynn is moved from</span>
</pre>
</div>

<p>
Now fixed.
</p>
</section>
<section id="slide-org3c3a1ba">
<h4 id="org3c3a1ba">The fix</h4>
<p>
Don't move the result of operator*, move the rhs and apply operator*().
</p>

<div class="org-src-container">

<pre class="src src-cpp"><span class="org-comment-delimiter">//</span><span class="org-comment">instead of</span>
*<span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-1">(</span>rhs<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">use</span>
<span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-1">(</span>*rhs<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Because
</p>
<div class="org-src-container">

<pre class="src src-cpp"><span class="org-constant">std</span>::<span class="org-constant">optional</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">T</span>&amp;<span class="org-rainbow-delimiters-depth-1">&gt;</span>::<span class="org-keyword">operator</span>*<span class="org-rainbow-delimiters-depth-1">()</span> &amp;&amp;;
</pre>
</div>

<p>
does not return an rvalue reference.
</p>
</section>
</section>
<section>
<section id="slide-orgac1b32c">
<h2 id="orgac1b32c">Future Standards Work</h2>
<div class="outline-text-2" id="text-orgac1b32c">
</div>
</section>
<section id="slide-orgd32a204">
<h3 id="orgd32a204"><code class="src src-cpp"><span class="org-constant">std</span>::expected</code></h3>
</section>
<section id="slide-org08782aa">
<h3 id="org08782aa"><code class="src src-cpp"><span class="org-constant">std</span>::variant</code></h3>
</section>
<section id="slide-orgd573b25">
<h3 id="orgd573b25"><code class="src src-cpp"><span class="org-constant">std</span>::<span class="org-constant">views</span>::single</code></h3>
</section>
<section id="slide-org0eb10a8">
<h3 id="org0eb10a8"><code class="src src-cpp">rebindable_reference</code></h3>
</section>
<section id="slide-orgbeecc6d">
<h3 id="orgbeecc6d">Exposition-only <code class="src src-cpp"><span class="org-type">movable_box</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>T<span class="org-rainbow-delimiters-depth-1">&gt;</span></code></h3>
</section>
</section>
<section>
<section id="slide-orgf7f8786">
<h2 id="orgf7f8786">Questions?</h2>
<p>
Remember a question starts with:
</p>

<ul>
<li class="fragment current-visible">who</li>
<li class="fragment current-visible">what</li>
<li class="fragment current-visible">when</li>
<li class="fragment current-visible">where</li>
<li class="fragment current-visible">how</li>
<li class="fragment current-visible">why</li>

</ul>

</section>
<section>
<h2>Questions?</h2>
<p>
or
</p>
<dl>
<dt>A propositional statement</dt><dd>a statement that has a truth value, either true or false, but not both.</dd>

</dl>

</section>
<section>
<h2>Questions?</h2>
<p>
and goes up at the end.
</p>

</section>
<section>
<h2>Questions?</h2>
<blockquote>
<p>
"More of a comment than a question &#x2026;"
</p>
</blockquote>
<p>
Is a propositional statement, but hold them for a moment.
</p>
</section>
</section>
<section>
<section id="slide-org4dc9a7e">
<h2 id="org4dc9a7e">Comments?</h2>

</section>
</section>
<section>
<section id="slide-org0d6ff2f">
<h2 id="org0d6ff2f">Thank You!</h2>

</section>
</section>
<section>
<section id="slide-orgfc320d6">
<h2 id="orgfc320d6">Bibliography</h2>
<style>.csl-entry{text-indent: -1.5em; margin-left: 1.5em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>Cacciola, F., and A. Krzemieński. 2012. “N3406: A Proposal to Add a Utility Class to Represent Optional Objects (Revision 2).” https://wg21.link/n3406; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_2"></a>———. 2013a. “N3527: A Proposal to Add a Utility Class to Represent Optional Objects (Revision 2).” https://wg21.link/n3527; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_3"></a>———. 2013b. “N3672: A Proposal to Add a Utility Class to Represent Optional Objects (Revision 4).” https://wg21.link/n3672; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_4"></a>Cacciola, Fernando. 2005. “N1878: A Proposal to Add an Utility Class to Represent Optional Objects (Revision 1).” https://wg21.link/n1878; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_5"></a>Dawes, Beman. 2016. “P0220R0: Adopt Library Fundamentals Ts for c++17.” https://wg21.link/p0220r0; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_6"></a>Downey, Steve. 2023. “P2988R0: Std:Optional.” https://wg21.link/p2988r0; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_7"></a>Meneide, JeanHeyd. 2018. “P1175R0: A Simple and Practical Optional Reference for c++.” https://wg21.link/p1175r0; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_8"></a>———. 2020. “P1683R0: References for Standard Library Vocabulary Types - an Optional Case Study.” https://wg21.link/p1683r0; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_9"></a>Sankel, David, Marco Foco, Darius Neațu, and Barry Revzin. 2024. “P3168R0: Give Std:Optional Range Support.” https://wg21.link/p3168r0; WG21.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_10"></a>Yaskin, Jeffrey. 2015. “N4529: Working Draft, c++ Extensions for Library Fundamentals, Version 2.” https://wg21.link/n4529; WG21.</div>
</div>
</section>
</section>
</div>
</div>
<style type="text/css">
    /* 1. Style header/footer <div> so they are positioned as desired. */
    #header-left {
        position: absolute;
        top: 0%;
        left: 0%;
    }
    #header-right {
        position: absolute;
        top: 0%;
        right: 0%;
    }
    #footer-left {
        position: absolute;
        bottom: 0%;
        left: 0%;
        font-size: 0.5em;
    }
</style>

<!-- 2. Create hidden header/footer <div> -->
<div id="hidden" style="display:none;">
<div id="header">
<div id="footer-left">© 2025 Bloomberg Finance L.P. All rights reserved.</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript">
// 3. On Reveal.js ready event, copy header/footer <div> into each `.slide-background` <div>
var header = $('#header').html();
if ( window.location.search.match( /print-pdf/gi ) ) {
Reveal.addEventListener( 'ready', function( event ) {
                                  $('.slide-background').append(header);
                                  });
}
else {
$('div.reveal').append(header);
}
</script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/math/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/notes/notes.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/search/search.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/zoom/zoom.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,
overview: true,
width: 1600,
height: 900,

transition: 'fade',
transitionSpeed: 'default',
showNotes: window.location.search.match( /print-pdf/gi ) ? 'separate-page' : false,

// Plugins with reveal.js 4.x
plugins: [ RevealMath, RevealMarkdown, RevealNotes, RevealSearch, RevealZoom ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
